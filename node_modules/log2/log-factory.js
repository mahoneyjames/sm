/*
LogFactory is a Singleton that manages writing log records to somewhere (at the moment it's console)
and keeping track of any log records that have been created, but not yet written. 

This allows us to write verbose logs without filling CloudWatch up with multiple lines of data

*/
//TODO - I have jumped through some hoops to make this a Singleton - better to create a "log" instance, and pass it into classes that require it?
const LogRecord = require("./log-record");

class LogFactory {  


    constructor() {
        this.decorateNewLogRecord = function(record){};
        this.entries = new Map();
        this.index=0;
        
        //this.output = console.out;
        this.output = new (require("./log-target-console"));
    }

    setLogRecordDecorator(builderFunction) {
        this.decorateNewLogRecord = builderFunction;
    }

    setOutput(output)
    {
        //console.log("here:" + output);
        this.output = output;
    }

    

    getLogRecord(category, label,level, trackRecord=false)
    {
        //console.log("getLogRecord" + this.output);
        let record = null;

        if(trackRecord==true)
        {
            const fullKey = `${category}-${label}`;
            if(!this.entries.has(fullKey))
            {
                record = new LogRecord(category, label, level);                
                this.entries.set(fullKey,record);
            }
            else
            {
                record = this.entries.get(fullKey);
            }
        }
        else
        {
            record = new LogRecord(category, label,level);
        }

        this.decorateNewLogRecord(record);

        return record;
    }

    writeUnsavedRecords()
    {
        for(const record of this.entries.values())
        {
            record.writeLogRecord();            
        }        

        this.entries.clear();
    }

    writeRecord(record)
    {                                
        const message = JSON.stringify(record);
            //TODO support log, warn, info etc

        this.output.log(message);
        return;
        //console.log("writeRecord" + this.output);
        if(this.output)
        {
            //console.log("memoery");
            this.output.log(message);
        }
        else
        {
        
           // console.log("hr");
           console.log(message);
        }
           
            
        
    }
    
    
}

module.exports = new LogFactory();
